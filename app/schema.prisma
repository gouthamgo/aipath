datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  email                     String?         @unique
  username                  String?         @unique
  isAdmin                   Boolean         @default(false)

  paymentProcessorUserId    String?         @unique
  lemonSqueezyCustomerPortalUrl String?
  subscriptionStatus        String?         // 'active', 'cancel_at_period_end', 'past_due', 'deleted'
  subscriptionPlan          String?         // 'free', 'pro', 'lifetime'
  datePaid                  DateTime?
  credits                   Int             @default(3)

  // Learning Progress
  currentStreak             Int             @default(0)
  longestStreak             Int             @default(0)
  totalLessonsCompleted     Int             @default(0)
  lastActiveAt              DateTime?

  // API Keys for AI lessons (encrypted)
  openaiApiKey              String?
  anthropicApiKey           String?

  gptResponses              GptResponse[]
  contactFormMessages       ContactFormMessage[]
  tasks                     Task[]
  files                     File[]
  progress                  UserProgress[]
  codeSubmissions           CodeSubmission[]
}

// ============== PROJECT ==============
model Project {
  id              String    @id @default(uuid())
  slug            String    @unique
  title           String
  description     String    @db.Text
  longDescription String?   @db.Text
  difficulty      String    // beginner, intermediate, advanced
  category        String    // foundations, langchain, agents, rag, deployment
  estimatedHours  Int
  order           Int       @unique
  isPublished     Boolean   @default(false)
  isPremium       Boolean   @default(true)
  imageUrl        String?

  prerequisites   String[]  @default([])
  skills          String[]  @default([])

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  lessons         Lesson[]
}

// ============== LESSON ==============
model Lesson {
  id                 String    @id @default(uuid())
  projectId          String
  project            Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  slug               String
  title              String
  order              Int
  estimatedMinutes   Int       @default(20)
  isPremium          Boolean   @default(true)

  // Content (Markdown)
  problemContent     String    @db.Text
  solutionContent    String    @db.Text
  explanationContent String    @db.Text
  connectionContent  String    @db.Text  // Real-world applications
  mistakesContent    String    @db.Text  // Common mistakes
  projectContent     String    @db.Text  // Project application
  interviewTip       String?   @db.Text  // Interview preparation

  // Code
  starterCode        String    @db.Text
  solutionCode       String    @db.Text
  testCode           String?   @db.Text

  // Hints (JSON array)
  hints              String?   @db.Text

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  progress           UserProgress[]
  submissions        CodeSubmission[]

  @@unique([projectId, slug])
  @@unique([projectId, order])
  @@index([projectId])
}

// ============== USER PROGRESS ==============
model UserProgress {
  id               String    @id @default(uuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId         String
  lesson           Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  status           String    @default("not_started")  // not_started, in_progress, completed
  completedAt      DateTime?
  timeSpentMinutes Int       @default(0)
  savedCode        String?   @db.Text
  hintsUsed        Int       @default(0)

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@index([status])
}

// ============== CODE SUBMISSION ==============
model CodeSubmission {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId    String
  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  code        String   @db.Text
  output      String?  @db.Text
  error       String?  @db.Text
  passed      Boolean  @default(false)

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([lessonId])
}

model GptResponse {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  content                   String
}

model Task {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  description               String
  time                      String          @default("1")
  isDone                    Boolean         @default(false)
}

model File {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  name                      String
  type                      String
  s3Key                     String
}

model DailyStats {
  id                               Int             @id @default(autoincrement())
  date                             DateTime        @default(now()) @unique

  totalViews                       Int             @default(0)
  prevDayViewsChangePercent        String          @default("0")
  userCount                        Int             @default(0)
  paidUserCount                    Int             @default(0)
  userDelta                        Int             @default(0)
  paidUserDelta                    Int             @default(0)
  totalRevenue                     Float           @default(0)
  totalProfit                      Float           @default(0)

  sources                          PageViewSource[]
}

model PageViewSource {
  @@id([date, name])
  name                     String
  date                     DateTime        @default(now())

  dailyStats               DailyStats?     @relation(fields: [dailyStatsId], references: [id])
  dailyStatsId             Int?

  visitors                 Int
}

model Logs {
  id                       Int             @id @default(autoincrement())
  createdAt                DateTime        @default(now())

  message                  String
  level                    String
}

model ContactFormMessage {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  content                   String
  isRead                    Boolean         @default(false)
  repliedAt                 DateTime?
}
